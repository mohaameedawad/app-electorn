<div class="page-header">
  <button class="add-button" (click)="showDialog()">+ إضافة فاتورة</button>
</div>
<app-table
  [columns]="columns"
  [data]="data"
  (edit)="onEdit($event)"
  (delete)="onDelete($event)"
  (preview)="onPreview($event)"
></app-table>
<app-confirmation-dialog></app-confirmation-dialog>

<app-dialog
  [(visible)]="visible"
  [width]="'60%'"
  [draggable]="false"
  (onHide)="onDialogHide()"
  [header]="'فاتورة مشتريات'"
>
  <div class="form-container">
    <div class="invoice-row">
      <div class="invoice-number">
        <span class="invoice-label">رقم الفاتورة:</span>
        <span class="invoice-value">{{ newPurchase.invoice_no }}</span>
      </div>

      <div class="row">
        <div class="col-3">
          <label class="mb-2">المورد</label>
          <p-select
            [(ngModel)]="newPurchase.supplierId"
            [options]="suppliers"
            optionLabel="label"
            optionValue="value"
            [filter]="true"
            filterBy="label"
            placeholder="اختر المورد"
            [appendTo]="'body'"
            [style]="{ width: '100%' }"
          >
          </p-select>
        </div>

        <div class="col-3">
          <label class="mb-2">الموظف</label>
          <p-select
            [(ngModel)]="newPurchase.employee_id"
            [options]="employees"
            optionLabel="label"
            optionValue="value"
            placeholder="اختر الموظف"
            [appendTo]="'body'"
            [style]="{ width: '100%' }"
          >
          </p-select>
        </div>

        <div class="col-3">
          <label class="mb-2">التاريخ</label>
          <p-datepicker
            [(ngModel)]="newPurchase.purchase_date"
            dateFormat="yy-mm-dd"
            [showIcon]="true"
            [appendTo]="'body'"
            [style]="{ width: '100%' }"
          >
          </p-datepicker>
        </div>
      </div>
    </div>

    <!-- Add Product Section -->
    <div class="add-product-section">
      <h4>إضافة صنف</h4>

      <div class="row align-items-start">
        <div class="col-md-4 col-12">
          <div class="input-wrapper">
            <label class="mb-2">المنتج</label>
            <p-select
              [(ngModel)]="currentItem.product_id"
              [options]="products"
              optionLabel="label"
              optionValue="value"
              [filter]="true"
              filterBy="label"
              placeholder="اختر المنتج"
              (onChange)="onProductChange()"
              [appendTo]="'body'"
              [class.error-input]="
                showValidationErrors && !currentItem.product_id
              "
              [style]="{ width: '100%' }"
            ></p-select>
            <small
              class="error-message"
              *ngIf="showValidationErrors && !currentItem.product_id"
              >هذا الحقل مطلوب</small
            >
          </div>
        </div>

        <div class="col-md-2 col-6 mx-2">
          <div class="input-wrapper">
            <label class="mb-2">الكمية</label>
            <p-inputnumber
              [(ngModel)]="currentItem.quantity"
              [showButtons]="false"
              (ngModelChange)="calculateItemTotal()"
              [class.error-input]="
                showValidationErrors && !currentItem.quantity
              "
              [style]="{ width: '100%' }"
            ></p-inputnumber>
            <small
              class="error-message"
              *ngIf="showValidationErrors && !currentItem.quantity"
              >هذا الحقل مطلوب</small
            >
          </div>
        </div>

        <div class="col-md-2 col-6 mx-2">
          <div class="input-wrapper">
            <label class="mb-2">السعر</label>
            <p-inputnumber
              [(ngModel)]="currentItem.price"
              [showButtons]="false"
              (ngModelChange)="calculateItemTotal()"
              [class.error-input]="showValidationErrors && !currentItem.price"
              [style]="{ width: '100%' }"
            ></p-inputnumber>
            <small
              class="error-message"
              *ngIf="showValidationErrors && !currentItem.price"
              >هذا الحقل مطلوب</small
            >
          </div>
        </div>

        <div class="col-md-2 col-12">
          <label class="mb-2" style="visibility: hidden">زر</label>
          <button class="add-button w-100 mx-3" (click)="addItem()">
            إضافة منتج
          </button>
        </div>
      </div>
    </div>

    <!-- Items Table -->
    <div class="items-table">
      <h4>الأصناف</h4>

      <p-table [value]="newPurchase.items">
        <ng-template pTemplate="header">
          <tr>
            <th>المنتج</th>
            <th>الكمية</th>
            <th>السعر</th>
            <th>الإجمالي</th>
            <th>حذف</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item let-i="rowIndex">
          <tr>
            <td>{{ item.product_name }}</td>

            <td>
              <p-inputnumber
                [(ngModel)]="item.quantity"
                [min]="1"
                [showButtons]="true"
                (ngModelChange)="updateItemTotal(i)"
                [style]="{ width: '100px' }"
              ></p-inputnumber>
            </td>

            <td>
              <p-inputnumber
                [(ngModel)]="item.price"
                [min]="0"
                (ngModelChange)="updateItemTotal(i)"
                [style]="{ width: '120px' }"
              ></p-inputnumber>
            </td>

            <td>{{ item.total }}</td>

            <td>
              <button class="delete-btn" (click)="removeItem(i)">
                <i class="pi pi-trash"></i>
              </button>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5" class="empty-message-center">لا توجد سجلات</td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Totals Section -->
    <div class="row">
      <div class="col-4">
        <label class="mb-2 col-12">الخصم</label>
        <p-inputnumber
          [(ngModel)]="newPurchase.discount"
          [min]="0"
          [showButtons]="false"
          (ngModelChange)="calculateInvoiceTotal()"
          [style]="{ width: '140px' }"
        ></p-inputnumber>
      </div>

      <div class="col-4">
        <label class="mb-2 col-12">الضريبة %</label>
        <p-inputnumber
          [(ngModel)]="newPurchase.tax"
          [min]="0"
          [max]="100"
          [showButtons]="false"
          (ngModelChange)="calculateInvoiceTotal()"
          [style]="{ width: '100px' }"
        ></p-inputnumber>
      </div>

      <div class="col-4">
        <label class="mb-2 col-12">المدفوع</label>
        <p-inputnumber
          [(ngModel)]="newPurchase.paid_amount"
          [min]="0"
          [showButtons]="false"
          (ngModelChange)="calculateInvoiceTotal()"
          [style]="{ width: '140px' }"
        ></p-inputnumber>
      </div>
    </div>

    <!-- Subtotal + Total + Remaining -->
    <div class="row mt-3">
      <div class="col-4">
        <label class="mb-2 col">الإجمالي (قبل الخصم):</label>
        <span class="mx-2">{{ newPurchase.subtotal }}</span>
      </div>

      <div class="col-4">
        <label class="mb-2 col">الإجمالي (بعد الخصم):</label>
        <span class="mx-2">{{ newPurchase.total }}</span>
      </div>

      <div class="col-4">
        <label class="mb-2 col">المتبقي:</label>
        <span class="mx-2">{{
          newPurchase.total - newPurchase.paid_amount
        }}</span>
      </div>
    </div>
  </div>

  <div dialog-footer class="dialog-footer">
    <p-button
      label="إلغاء"
      severity="secondary"
      (onClick)="closeDialog()"
      [text]="true"
    ></p-button>
    <p-button label="حفظ" (onClick)="savePurchase()"></p-button>
  </div>
</app-dialog>

<!-- ======================= Preview Dialog ======================= -->

<app-dialog
  [(visible)]="previewVisible"
  [width]="'900px'"
  [draggable]="false"
  [header]="'معاينة الفاتورة'"
>
  <div class="invoice-preview px-3">
    <div class="company-info">
      <h2 class="company-name">{{ companyName }}</h2>
      <p class="company-phone">رقم الهاتف: {{ companyPhone }}</p>
    </div>

    <div class="invoice-header">
      <h1>فاتورة مشتريات</h1>
    </div>

    <div class="customer-info">
      <div class="info-row">
        <div class="info-item">
          <span class="label">المورد:</span>
          <span class="value">{{
            getSupplierName(previewPurchase.supplierId)
          }}</span>
        </div>

        <div class="info-item">
          <span class="label">رقم الفاتورة:</span>
          <span class="value">{{ previewPurchase.invoice_no }}</span>
        </div>
      </div>

      <div class="info-row">
        <div class="info-item">
          <span class="label">التاريخ:</span>
          <span class="value">{{
            formatPreviewDate(previewPurchase.purchase_date)
          }}</span>
        </div>
      </div>
    </div>

    <table class="preview-table">
      <thead>
        <tr>
          <th>الوصف</th>
          <th>الكمية</th>
          <th>السعر</th>
          <th>الإجمالي</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let item of previewPurchase.items">
          <td>{{ item.product_name }}</td>
          <td>{{ item.quantity }}</td>
          <td>{{ item.price }} ج.م</td>
          <td>{{ item.total }} ج.م</td>
        </tr>
      </tbody>
    </table>

    <table class="preview-table totals-table">
      <tbody>
        <tr>
          <td class="total-header">الإجمالي</td>
          <td class="total-value">{{ previewPurchase.subtotal }} ج.م</td>

          <ng-container *ngIf="previewPurchase.discount > 0">
            <td class="total-header">الخصم</td>
            <td class="total-value">{{ previewPurchase.discount }} ج.م</td>

            <td class="total-header">الصافي</td>
            <td class="total-value final-total">
              {{ previewPurchase.total }} ج.م
            </td>
          </ng-container>
        </tr>
      </tbody>
    </table>
  </div>

  <div dialog-footer class="dialog-footer">
    <p-button
      label="إغلاق"
      severity="secondary"
      (onClick)="closePreview()"
      [text]="true"
    ></p-button>
    <p-button
      label="طباعة"
      icon="pi pi-print"
      (onClick)="printPreview()"
    ></p-button>
  </div>
</app-dialog>
