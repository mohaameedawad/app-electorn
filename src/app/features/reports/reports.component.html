<div class="reports-container" id="reportCards">
  <div class="row">
    <div class="col-md-10">
      <div class="row g-3">
        <div class="col-md-4" *ngFor="let card of reportCards">
          <div class="report-card" (click)="openReport(card.type)">
            <i [class]="card.icon + ' report-icon'"></i>
            <h4>{{ card.title }}</h4>
            <p>{{ card.description }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Unified Report Dialog -->
<app-dialog
  [(visible)]="displayReportDialog"
  [width]="'80vw'"
  [header]="reportTitles[currentReport]"
>
  <div class="p-4">
    <!-- مصروفات / مشتريات / أرباح -->
    <div
      *ngIf="['expenses', 'purchases', 'profits'].includes(currentReport)"
      class="row mb-3"
    >
      <div class="col-md-3">
        <label class="mb-2">من تاريخ</label>
        <p-datepicker
          [(ngModel)]="dateFrom"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          styleClass="w-100"
          (onSelect)="generateReport()"
          appendTo="body"
        ></p-datepicker>
      </div>

      <div class="col-md-3">
        <label class="mb-2">إلى تاريخ</label>
        <p-datepicker
          [(ngModel)]="dateTo"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          styleClass="w-100"
          (onSelect)="generateReport()"
          appendTo="body"
        ></p-datepicker>
      </div>
    </div>

    <!-- تقرير دفعات العملاء -->
    <div *ngIf="currentReport === 'customerPayments'" class="row mb-3">
      <div class="col-md-3">
        <label class="mb-2">اختر العميل</label>
        <p-select
          [(ngModel)]="selectedCustomerPayment"
          [options]="customers"
          optionLabel="name"
          optionValue="id"
          placeholder="اختر العميل"
          styleClass="w-100"
          (onChange)="generateReport()"
          appendTo="body"
        ></p-select>
      </div>

      <div class="col-md-3">
        <label class="mb-2">من تاريخ</label>
        <p-datepicker
          [(ngModel)]="dateFrom"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          styleClass="w-100"
          (onSelect)="generateReport()"
          appendTo="body"
        ></p-datepicker>
      </div>

      <div class="col-md-3">
        <label class="mb-2">إلى تاريخ</label>
        <p-datepicker
          [(ngModel)]="dateTo"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          styleClass="w-100"
          (onSelect)="generateReport()"
          appendTo="body"
        ></p-datepicker>
      </div>
    </div>

    <!-- تقرير دفعات الموردين -->
    <div *ngIf="currentReport === 'supplierPayments'" class="row mb-3">
      <div class="col-md-3">
        <label class="mb-2">اختر المورد</label>
        <p-select
          [(ngModel)]="selectedSupplierPayment"
          [options]="suppliers"
          optionLabel="name"
          optionValue="id"
          placeholder="اختر المورد"
          styleClass="w-100"
          (onChange)="generateReport()"
          appendTo="body"
        ></p-select>
      </div>

      <div class="col-md-3">
        <label class="mb-2">من تاريخ</label>
        <p-datepicker
          [(ngModel)]="dateFrom"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          styleClass="w-100"
          (onSelect)="generateReport()"
          appendTo="body"
        ></p-datepicker>
      </div>

      <div class="col-md-3">
        <label class="mb-2">إلى تاريخ</label>
        <p-datepicker
          [(ngModel)]="dateTo"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          styleClass="w-100"
          (onSelect)="generateReport()"
          appendTo="body"
        ></p-datepicker>
      </div>
    </div>

    <!-- كشف حساب عميل -->
    <div *ngIf="currentReport === 'customer'" class="row mb-3">
      <div class="col-md-3">
        <label class="mb-2">اختر العميل</label>
        <p-select
          [(ngModel)]="selectedCustomer"
          [options]="customers"
          optionLabel="name"
          placeholder="اختر العميل"
          styleClass="w-100"
          (onChange)="generateReport()"
          appendTo="body"
        ></p-select>
      </div>
    </div>

    <!-- كشف حساب مورد -->
    <div *ngIf="currentReport === 'supplier'" class="row mb-3">
      <div class="col-md-3">
        <label class="mb-2">اختر المورد</label>
        <p-select
          [(ngModel)]="selectedSupplier"
          [options]="suppliers"
          optionLabel="name"
          optionValue="id"
          placeholder="اختر المورد"
          styleClass="w-100"
          (onChange)="generateReport()"
          appendTo="body"
        ></p-select>
      </div>
    </div>

    <!-- TABLE -->
    <div class="report-preview" id="reportPreview">
      <app-table
        [columns]="currentColumns"
        [data]="currentData"
        [showFilter]="false"
      ></app-table>
    </div>
    <div *ngIf="totalSum > 0" class="total-summary-box">
      <span class="label mx-2">
        {{
          currentReport === "purchases"
            ? "إجمالي المشتريات"
            : currentReport === "expenses"
            ? "إجمالي المصروفات"
            : "الإجمالي"
        }}
      </span>

      <span class="value"> {{ totalSum | number : "1.2-2" }} جنيه </span>
    </div>
  </div>

  <!-- Dialog Footer -->
  <div dialog-footer class="dialog-footer">
    <p-button
      label="إغلاق"
      severity="secondary"
      [text]="true"
      (onClick)="closeReport()"
    ></p-button>

    <p-button
      label="طباعة"
      icon="pi pi-print"
      (onClick)="printPreview()"
    ></p-button>
  </div>
</app-dialog>

<!-- PRINT TEMPLATE -->
<div id="reportPrint" style="display: none">
  <div class="print-header">
    <h1>{{ reportTitles[currentReport] }}</h1>

    <h2 *ngIf="currentReport === 'customer' && selectedCustomer">
      العميل: {{ selectedCustomer.name }}
    </h2>

    <h2 *ngIf="currentReport === 'supplier' && selectedSupplier">
      المورد: {{ selectedSupplier?.name }}
    </h2>

    <hr />
  </div>

  <table class="print-table">
    <thead>
      <tr>
        <th *ngFor="let col of currentColumns">{{ col.header }}</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let row of currentData">
        <td *ngFor="let col of currentColumns">
          {{ row[col.field] }}
        </td>
      </tr>
    </tbody>
    <div *ngIf="totalSum > 0" class="total-summary-box" >
      <span class="label mx-2">
        {{
          currentReport === "purchases"
            ? "إجمالي المشتريات"
            : currentReport === "expenses"
            ? "إجمالي المصروفات"
            : "الإجمالي"
        }}
      </span>

      <span class="value"> {{ totalSum | number : "1.2-2" }} جنيه </span>
    </div>
  </table>
</div>

<app-confirmation-dialog></app-confirmation-dialog>
